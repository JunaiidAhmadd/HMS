<%- include("partials/admin_header", { pageTitle: "Branch Management" }) %>

<style>
  /* ============================
     CUSTOM STYLES (Modern & Clean)
     ============================ */
  :root {
    /* Define primary colors for cleaner appearance */
    --primary-color: #4361ee;
    --bg-light: #f4f7fe;
    --card-border: #eef2f6;
  }

  /* GLOBAL LAYOUT FIX (Simplified) */
  body {
    background-color: var(--bg-light); /* Use custom variable */
    margin: 0;
    padding: 0;
  }

  /* Admin Wrapper - Removed unnecessary !important */
  .admin-wrapper {
    display: flex; 
    flex-direction: row; 
    width: 100%;
    min-height: 100vh; /* Use min-height for better flow */
  }

  .flex-grow-1 {
    flex-grow: 1; 
    width: 100%; 
    overflow-y: auto; 
  }

  /* SIDEBAR FIX (Simplified) */
  /* Assuming your sidebar partial handles the d-none/d-md-block logic */
  #sidebar {
    height: 100vh; 
    overflow: hidden; 
  }

  @media (max-width: 767px) {
    #sidebar {
      position: fixed; 
      left: -250px; 
      transition: 0.3s ease;
      z-index: 1040; /* Ensure sidebar is above content */
    }
    #sidebar.active {
      left: 0;
    }
  }

  /* MODERN CARD & TABLE STYLING */
  .custom-card {
    border: 1px solid var(--card-border);
    border-radius: 16px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05); /* Softer, modern shadow */
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    background: white;
  }

  .table-hover tbody tr:hover {
    background-color: #f8f9ff;
  }

  /* Facility Badge */
  .facility-badge {
    background-color: #e0e7ff; /* Light indigo background */
    color: var(--primary-color); /* Indigo text */
    padding: 6px 12px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  /* MOBILE ACTION BUTTONS (Clean Grid) */
  .mobile-actions {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;
    margin-top: 16px;
  }
</style>

<div id="sidebarOverlay" onclick="toggleSidebar()"></div>

<div class="admin-wrapper">

  <%- include("partials/admin_sidebar", { activePage: "branches" }) %>

  <div class="flex-grow-1">

    <header class="d-none d-md-flex justify-content-between align-items-center bg-white shadow-sm py-3 px-4 border-bottom">
      <h5 class="fw-bold m-0">Branches</h5>
      <div class="d-flex align-items-center gap-2">
        <span>Admin</span>
        <i class="bi bi-person-circle fs-4"></i>
      </div>
    </header>

    <main class="p-3 p-md-4">

      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h4 class="fw-bold mb-1">Branch List</h4>
          <p class="text-muted small mb-0">Manage your locations and facilities</p>
        </div>
        <button class="btn btn-primary shadow-sm" data-bs-toggle="modal" data-bs-target="#addBranchModal" style="border-radius: 10px;">
          <i class="bi bi-plus-lg me-1"></i> Add Branch
        </button>
      </div>

      <div class="custom-card d-none d-md-block overflow-hidden">
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0">
            <thead class="bg-light text-secondary">
              <tr>
                <th class="ps-4 py-3 text-uppercase small fw-bold">Name & Location</th>
                <th class="py-3 text-uppercase small fw-bold">Facilities</th>
                <th class="py-3 text-uppercase small fw-bold text-end pe-4">Actions</th>
              </tr>
            </thead>
            <tbody>
              <% if (branches && branches.length > 0) { %>
                <% branches.forEach(b => { %>
                  <tr>
                    <td class="ps-4 py-3">
                      <div class="d-flex flex-column">
                        <span class="fw-bold text-dark"><%= b.name %></span>
                        <small class="text-muted"><i class="bi bi-geo-alt me-1"></i><%= b.address %></small>
                      </div>
                    </td>

                    <td>
                      <div class="d-flex flex-wrap gap-1">
                        <% b.facilities.forEach(f => { %>
                          <span class="facility-badge"><%= f %></span>
                        <% }) %>
                      </div>
                    </td>

                    <td class="text-end pe-4">
                      <button class="btn btn-light text-primary btn-sm me-1" 
                              data-bs-toggle="modal" 
                              data-bs-target="#editBranchModal-<%= b._id %>"
                              title="Edit">
                        <i class="bi bi-pencil-square fs-6"></i>
                      </button>

                      <form action="/admin/branches/<%= b._id %>/delete" method="POST" class="d-inline-block" onsubmit="return confirm('Are you sure you want to delete this branch?')">
                        <button class="btn btn-light text-danger btn-sm" title="Delete">
                          <i class="bi bi-trash fs-6"></i>
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }) %>
              <% } else { %>
                <tr>
                  <td colspan="3" class="text-center py-5 text-muted">
                    <div class="d-flex flex-column align-items-center">
                      <i class="bi bi-building-slash fs-1 opacity-50 mb-2"></i>
                      <span>No branches found. Add one to get started.</span>
                    </div>
                  </td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>

      <div class="d-md-none">
        <% if (branches && branches.length > 0) { %>
          <% branches.forEach(b => { %>
            <div class="custom-card mobile-card p-3 mb-3">
              
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <h6 class="fw-bold text-dark mb-1"><%= b.name %></h6>
                  <p class="small text-muted mb-0">
                    <i class="bi bi-geo-alt-fill text-danger me-1"></i><%= b.address %>
                  </p>
                </div>
                <div class="bg-light rounded p-1">
                   <i class="bi bi-building text-secondary"></i>
                </div>
              </div>

              <hr class="my-2 border-light">

              <div class="mb-3">
                <small class="text-uppercase text-muted fw-bold" style="font-size: 0.65rem;">Facilities</small>
                <div class="d-flex flex-wrap gap-1 mt-1">
                  <% b.facilities.slice(0, 4).forEach(f => { %>
                    <span class="badge bg-light text-dark border"><%= f %></span>
                  <% }) %>
                  <% if(b.facilities.length > 4) { %>
                    <span class="badge bg-light text-muted border">+<%= b.facilities.length - 4 %> more</span>
                  <% } %>
                </div>
              </div>

              <div class="mobile-actions">
                <button class="btn btn-outline-primary btn-sm" 
                        data-bs-toggle="modal" 
                        data-bs-target="#editBranchModal-<%= b._id %>">
                  <i class="bi bi-pencil me-1"></i> Edit
                </button>

                <form action="/admin/branches/<%= b._id %>/delete" method="POST" onsubmit="return confirm('Delete branch?')">
                  <button type="submit" class="btn btn-outline-danger btn-sm w-100">
                    <i class="bi bi-trash me-1"></i> Delete
                  </button>
                </form>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="text-center py-5 text-muted">
            <i class="bi bi-inbox fs-1 opacity-50"></i>
            <p class="mt-2">No branches available.</p>
          </div>
        <% } %>
      </div>

    </main>
  </div>

</div>

<%- include("partials/modals/add_branch") %>
<% if (branches) { %>
  <% branches.forEach(b => { %>
    <%- include("partials/modals/edit_branch", { branch: b }) %>
  <% }) %>
<% } %>

<script>
  function toggleSidebar() {
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    
    // Check if the sidebar has a 'show' class for mobile
    sidebar.classList.toggle('active'); // Changed to 'active' based on your CSS
    
    if (sidebar.classList.contains('active')) {
        overlay.classList.add('show');
    } else {
        overlay.classList.remove('show');
    }
  }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>