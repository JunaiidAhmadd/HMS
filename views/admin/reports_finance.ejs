<%- include("partials/admin_header", { pageTitle: "Finance" }) %>

  <style>
    body {
      background-color: #f8f9fa !important;
      margin: 0;
      overflow-x: hidden;
    }

    .admin-wrapper {
      display: flex;
      width: 100%;
    }

    .flex-grow-1 {
      width: 100%;
    }

    .overview-card {
      border-radius: 10px;
      padding: 1.3rem;
      text-align: center;
      border: 1px solid #e2e2e2;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.07);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      color: #fff;
    }

    .overview-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.18);
    }

    .overview-card h6 {
      margin-top: .4rem;
      font-size: .8rem;
      text-transform: uppercase;
      color: rgba(255, 255, 255, 0.85);
    }

    .overview-card .card-icon {
      font-size: 2rem;
      margin-bottom: .35rem;
    }

    .overview-card--revenue {
      background: linear-gradient(135deg, #0d6efd, #4dabff);
    }

    .overview-card--expense {
      background: linear-gradient(135deg, #dc3545, #ff758f);
    }

    .overview-card--profit {
      background: linear-gradient(135deg, #198754, #51cf66);
    }

    .overview-card .card-value {
      font-size: 1.6rem;
      font-weight: bold;
      margin-top: 5px;
    }

    .table th {
      background: #1a1d23;
      color: white;
      font-size: .85rem;
      text-transform: uppercase;
    }

    .chart-wrapper {
      position: relative;
      width: 100%;
      min-height: 260px;
    }
  </style>

  <div class="admin-wrapper">

    <!-- SIDEBAR -->
    <%- include("partials/admin_sidebar", { activePage: "finance" }) %>

      <!-- MAIN CONTENT -->
      <div class="flex-grow-1">

        <!-- HEADER -->
        <header class="d-flex justify-content-between bg-white py-3 px-4 shadow-sm">
          <h5 class="fw-bold">Finance Overview</h5>
          <div class="d-flex align-items-center gap-3">
            <span>Admin</span>
            <i class="bi bi-person-circle fs-4"></i>
          </div>
        </header>

        <main class="p-4">

          <!-- Filters -->
          <div class="row mb-4">
            <div class="col-md-3">
              <label class="form-label">Year</label>
              <select id="yearSelect" class="form-select">
                <% for (let y = year - 2; y <= year + 1; y++) { %>
                  <option value="<%= y %>" <%= y === year ? 'selected' : '' %>><%= y %></option>
                <% } %>
              </select>
            </div>
          </div>

          <!-- Summary cards -->
          <div class="row g-3 mb-4">
            <div class="col-12 col-md-4">
              <div class="overview-card overview-card--revenue">
                <div class="card-icon"><i class="bi bi-graph-up-arrow"></i></div>
                <h6>Total Revenue</h6>
                <div class="card-value" id="totalRevenue">0</div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="overview-card overview-card--expense">
                <div class="card-icon"><i class="bi bi-cash-coin"></i></div>
                <h6>Total Expense</h6>
                <div class="card-value" id="totalExpense">0</div>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <div class="overview-card overview-card--profit">
                <div class="card-icon"><i class="bi bi-coin"></i></div>
                <h6>Total Profit</h6>
                <div class="card-value" id="totalProfit">0</div>
              </div>
            </div>
          </div>

          <!-- Monthly table -->
          <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <h6 class="mb-0">Monthly Revenue vs Expense</h6>
            </div>
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0">
                <thead>
                  <tr>
                    <th>Month</th>
                    <th>Revenue</th>
                    <th>Expense</th>
                    <th>Profit</th>
                  </tr>
                </thead>
                <tbody id="financeTableBody">
                </tbody>
              </table>
            </div>
          </div>

          <!-- Simple chart using canvas (Chart.js) -->
          <div class="card shadow-sm">
            <div class="card-header bg-white">
              <h6 class="mb-0">Revenue / Expense / Profit Chart</h6>
            </div>
            <div class="card-body">
              <div class="chart-wrapper">
                <canvas id="financeChart"></canvas>
              </div>
            </div>
          </div>

        </main>

      </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const monthNames = [
      "Jan", "Feb", "Mar", "Apr", "May", "Jun",
      "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
    ];

    const yearSelect = document.getElementById("yearSelect");
    const tableBody = document.getElementById("financeTableBody");
    const totalRevenueEl = document.getElementById("totalRevenue");
    const totalExpenseEl = document.getElementById("totalExpense");
    const totalProfitEl = document.getElementById("totalProfit");

    let chartInstance = null;

    async function loadFinanceData() {
      const year = yearSelect.value;

      const res = await fetch(`/admin/reports/monthly?year=${year}`);
      const json = await res.json();
      if (!json.success) return;

      const data = json.data || [];

      // Update table
      tableBody.innerHTML = "";
      let tRevenue = 0, tExpense = 0, tProfit = 0;

      data.forEach(row => {
        const tr = document.createElement("tr");
        const monthLabel = monthNames[row.month - 1];

        tr.innerHTML = `
          <td>${monthLabel}</td>
          <td>${row.revenue}</td>
          <td>${row.expense}</td>
          <td>${row.profit}</td>
        `;
        tableBody.appendChild(tr);

        tRevenue += row.revenue;
        tExpense += row.expense;
        tProfit += row.profit;
      });

      totalRevenueEl.textContent = tRevenue;
      totalExpenseEl.textContent = tExpense;
      totalProfitEl.textContent = tProfit;

      // Update chart
      const labels = data.map(r => monthNames[r.month - 1]);
      const revenues = data.map(r => r.revenue);
      const expenses = data.map(r => r.expense);
      const profits = data.map(r => r.profit);

      const ctx = document.getElementById("financeChart").getContext("2d");
      if (chartInstance) {
        chartInstance.destroy();
      }

      chartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Revenue",
              data: revenues,
              backgroundColor: "rgba(13, 110, 253, 0.6)",
            },
            {
              label: "Expense",
              data: expenses,
              backgroundColor: "rgba(220, 53, 69, 0.6)",
            },
            {
              label: "Profit",
              data: profits,
              backgroundColor: "rgba(25, 135, 84, 0.6)",
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
            },
          },
        },
      });
    }

    yearSelect.addEventListener("change", loadFinanceData);

    // Initial load
    loadFinanceData();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
