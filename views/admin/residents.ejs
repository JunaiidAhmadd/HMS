<%- include("partials/admin_header", { pageTitle: "Residents & Rent" }) %>

  <style>
    body {
      background-color: #f8f9fa;
      width: 100%;
      margin: 0;
      padding: 0;
      overflow-x: hidden;
    }

    .admin-wrapper {
      display: flex;
      height: 100vh;
      width: 100%;
      overflow: hidden;
    }

    #sidebar {
      width: 250px;
      height: 100vh;
      background: #13192f;
      overflow: hidden !important;
      position: sticky;
      top: 0;
    }

    .flex-grow-1 {
      flex-grow: 1;
      height: 100vh;
      overflow-y: auto;
      background-color: #f8f9fa;
    }

    /* Mobile Sidebar */
    @media (max-width: 768px) {
      #sidebar {
        position: fixed;
        left: -260px;
        transition: 0.3s ease;
        z-index: 1200;
      }

      #sidebar.active {
        left: 0;
      }
    }

    /* Table header */
    .table thead {
      background-color: #1b1e24;
      color: white !important;
    }

    /* Mobile card */
    .resident-card {
      background: white;
      border-radius: 10px;
      border: 1px solid #dee2e6;
      padding: 1rem;
      margin-bottom: 15px;
    }

    .resident-card .info {
      color: #6c757d;
      font-size: 0.9rem;
    }

    /* Search Bar */
    .search-bar {
      width: 100%;
      padding: 12px 18px;
      border-radius: 8px;
      border: 1px solid #ced4da;
      font-size: 16px;
      margin-bottom: 20px;
    }

    .btn-view {
      background-color: #0d6efd;
      color: white;
    }

    .btn-view:hover {
      background-color: #0b5ed7;
    }
  </style>

  <div id="sidebarOverlay"></div>

  <div class="admin-wrapper">

    <!-- SIDEBAR -->
    <%- include("partials/admin_sidebar", { activePage: "residents" }) %>

      <!-- MAIN CONTENT -->
      <div class="flex-grow-1">

        <!-- DESKTOP HEADER -->
        <header class="d-none d-md-flex justify-content-between bg-white py-3 px-4 shadow-sm">
          <h5 class="fw-bold">Residents</h5>
          <div class="d-flex align-items-center gap-3">
            <!-- Overdue Notification Bell -->
            <div class="position-relative">
              <button class="btn btn-link text-dark p-0" data-bs-toggle="modal" data-bs-target="#overdueModal"
                id="overdueIcon">
                <i class="bi bi-bell-fill fs-4"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger"
                  id="overdueBadge" style="display: none;">
                  0
                </span>
              </button>
            </div>
            <span>Admin</span>
            <i class="bi bi-person-circle fs-4"></i>
          </div>
        </header>

        <main class="p-4">

          <h4 class="fw-bold mb-4">Current Residents</h4>

          <!-- ðŸ” SEARCH BAR -->
          <!-- ðŸ” SEARCH & FILTER -->
          <div class="d-flex gap-2 mb-4">
            <input type="text" id="searchInput" class="search-bar mb-0" placeholder="Search residents...">
            
            <select id="branchFilter" class="form-select w-auto" style="min-width: 150px;">
              <option value="">All Branches</option>
              <% if (typeof branches !== 'undefined' && branches.length > 0) { %>
                <% branches.forEach(b => { %>
                  <option value="<%= b.name %>"><%= b.name %></option>
                <% }) %>
              <% } %>
            </select>
          </div>

          <!-- DESKTOP TABLE -->
          <div class="card shadow-sm d-none d-md-block" style="border-radius: 12px">
            <div class="table-responsive" style="border-radius: 12px">
              <table class="table table-hover align-middle mb-0" style="border-radius: 12px">
                <thead class="table-dark">
                  <tr>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Branch</th>
                    <th>Room Type</th>
                    <th>Monthly Rent</th>
                    <th>Start Date</th>
                    <th class="text-center">Payments</th>
                  </tr>
                </thead>

                <tbody id="residentTable">
                  <% if (residents && residents.length> 0) { %>

                    <% residents.forEach(r=> { %>
                      <tr class="search-row" data-branch="<%= r.branchName %>">
                        <td><strong>
                            <%= r.fullName %>
                          </strong></td>
                        <td>
                          <%= r.email %>
                        </td>
                        <td>
                          <%= r.branchName %>
                        </td>
                        <td>
                          <%= r.roomType %>
                        </td>
                        <td>PKR <%= r.monthlyRent %>
                        </td>
                        <td>
                          <%= r.createdAt.toLocaleDateString() %>
                        </td>
                        <td class="text-center">
                          <a href="/admin/residents/<%= r._id %>/payments" class="btn btn-sm btn-outline-primary">
                            View / Add
                          </a>
                        </td>
                      </tr>
                      <% }) %>

                        <% } else { %>
                          <tr>
                            <td colspan="7" class="text-center py-5 text-muted">
                              <i class="bi bi-inbox fs-2"></i><br>No residents found.
                            </td>
                          </tr>
                          <% } %>
                </tbody>
              </table>
            </div>
          </div>

          <!-- MOBILE CARDS -->
          <div class="d-md-none" id="mobileResidentList">

            <% if (residents && residents.length> 0) { %>

              <% residents.forEach(r=> { %>
                <div class="resident-card shadow-sm search-row" data-branch="<%= r.branchName %>">

                  <strong>
                    <%= r.fullName %>
                  </strong>

                  <div class="info"><i class="bi bi-envelope"></i>
                    <%= r.email %>
                  </div>
                  <div class="info"><i class="bi bi-geo-alt"></i> Branch: <%= r.branchName %>
                  </div>
                  <div class="info"><i class="bi bi-door-open"></i> Room: <%= r.roomType %>
                  </div>
                  <div class="info"><i class="bi bi-cash"></i> Rent: PKR <%= r.monthlyRent %>
                  </div>
                  <div class="info"><i class="bi bi-calendar"></i> Start: <%= r.createdAt.toLocaleDateString() %>
                  </div>

                  <a href="/admin/residents/<%= r._id %>/payments" class="btn btn-view btn-sm w-100 mt-3">
                    View / Add Payments
                  </a>

                </div>
                <% }) %>

                  <% } else { %>

                    <div class="text-center text-muted py-5">
                      <i class="bi bi-inbox fs-1"></i><br>No residents found.
                    </div>

                    <% } %>

          </div>

        </main>
      </div>
  </div>

  <!-- Overdue Rent Modal -->
  <div class="modal fade" id="overdueModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title"><i class="bi bi-exclamation-triangle-fill me-2"></i>Overdue Rent Payments</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <p class="text-muted mb-3">Users who haven't paid rent by the 5th of this month:</p>
          <div id="overdueTableContainer">
            <div class="text-center" id="overdueLoading">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
            </div>
            <table class="table table-sm" id="overdueTable" style="display:none;">
              <thead class="table-dark">
                <tr>
                  <th>Name</th>
                  <th>Branch</th>
                  <th>Room</th>
                  <th>Rent</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="overdueTableBody">
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
            <p id="noOverdueMessage" class="text-center text-muted" style="display:none;">
              <i class="bi bi-check-circle fs-2"></i><br>No overdue payments!
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ðŸ” LIVE SEARCH SCRIPT -->
  <script>
    function filterTable() {
      let search = document.getElementById("searchInput").value.toLowerCase();
      let branch = document.getElementById("branchFilter").value.toLowerCase();
      let rows = document.querySelectorAll(".search-row");

      rows.forEach(row => {
        let text = row.innerText.toLowerCase();
        let rowBranch = (row.getAttribute("data-branch") || "").toLowerCase();

        let matchesSearch = text.includes(search);
        let matchesBranch = branch === "" || rowBranch === branch;

        row.style.display = matchesSearch && matchesBranch ? "" : "none";
      });
    }

    document.getElementById("searchInput").addEventListener("keyup", filterTable);
    document.getElementById("branchFilter").addEventListener("change", filterTable);

    // Fetch and display overdue count on page load
    async function fetchOverdueCount() {
      try {
        const res = await fetch('/admin/residents/overdue/list');
        const data = await res.json();
        const count = data.overdue ? data.overdue.length : 0;

        const badge = document.getElementById('overdueBadge');
        if (count > 0) {
          badge.textContent = count;
          badge.style.display = 'inline-block';
        } else {
          badge.style.display = 'none';
        }
      } catch (err) {
        console.error('Error fetching overdue count:', err);
      }
    }

    // Load overdue list when modal opens
    document.getElementById('overdueModal').addEventListener('show.bs.modal', async function () {
      const loading = document.getElementById('overdueLoading');
      const table = document.getElementById('overdueTable');
      const noMessage = document.getElementById('noOverdueMessage');
      const tbody = document.getElementById('overdueTableBody');

      loading.style.display = 'block';
      table.style.display = 'none';
      noMessage.style.display = 'none';

      try {
        const res = await fetch('/admin/residents/overdue/list');
        const data = await res.json();

        loading.style.display = 'none';

        if (data.overdue && data.overdue.length > 0) {
          tbody.innerHTML = '';
          data.overdue.forEach(item => {
            const row = `
          <tr>
            <td>${item.userName}</td>
            <td>${item.branchName}</td>
            <td>${item.roomType}</td>
            <td>PKR ${item.rentAmount}</td>
            <td>
              <form action="/admin/residents/overdue/mark-paid" method="POST" style="display:inline;">
                <input type="hidden" name="reservationId" value="${item.reservationId}">
                <input type="hidden" name="userId" value="${item.userId}">
                <input type="hidden" name="amount" value="${item.rentAmount}">
                <button class="btn btn-success btn-sm" onclick="return confirm('Mark as paid?')">
                  <i class="bi bi-check"></i> Paid
                </button>
              </form>
              <button class="btn btn-secondary btn-sm" onclick="dismissNotification(this)">
                <i class="bi bi-x"></i> Dismiss
              </button>
            </td>
          </tr>
        `;
            tbody.innerHTML += row;
          });
          table.style.display = 'table';
        } else {
          noMessage.style.display = 'block';
        }
      } catch (err) {
        console.error('Error loading overdue list:', err);
        loading.style.display = 'none';
        noMessage.textContent = 'Error loading data';
        noMessage.style.display = 'block';
      }
    });

    function dismissNotification(btn) {
      const row = btn.closest('tr');
      row.remove();

      // Update badge count
      const remainingRows = document.querySelectorAll('#overdueTableBody tr').length;
      const badge = document.getElementById('overdueBadge');
      if (remainingRows > 0) {
        badge.textContent = remainingRows;
      } else {
        badge.style.display = 'none';
        document.getElementById('overdueTable').style.display = 'none';
        document.getElementById('noOverdueMessage').style.display = 'block';
      }
    }

    // Load count on page load
    fetchOverdueCount();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>