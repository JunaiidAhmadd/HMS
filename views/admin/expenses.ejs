<%- include("partials/admin_header", { pageTitle: "Expenses" }) %>

  <style>
    body {
      background-color: #f8f9fa !important;
      margin: 0;
      overflow-x: hidden;
    }

    .admin-wrapper {
      display: flex;
      width: 100%;
    }

    .flex-grow-1 {
      width: 100%;
    }

    .table th {
      background: #1a1d23;
      color: white;
      font-size: .85rem;
      text-transform: uppercase;
    }

    .overview-card {
      background: white;
      border-radius: 10px;
      padding: 1.3rem;
      border: 1px solid #e2e2e2;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.07);
    }
  </style>

  <div class="admin-wrapper">

    <!-- SIDEBAR -->
    <%- include("partials/admin_sidebar", { activePage: "expenses" }) %>

      <!-- MAIN CONTENT -->
      <div class="flex-grow-1">

        <!-- HEADER -->
        <header class="d-flex justify-content-between bg-white py-3 px-4 shadow-sm">
          <h5 class="fw-bold">Expenses</h5>
          <div class="d-flex align-items-center gap-3">
            <span>Admin</span>
            <i class="bi bi-person-circle fs-4"></i>
          </div>
        </header>

        <main class="p-4">

          <!-- Filters heading -->
          <h6 class="mb-3">Filters</h6>
          <div class="row mb-4">
            <div class="col-md-3">
              <label class="form-label">Year</label>
              <select id="expYear" class="form-select">
                <% for (let y = year - 2; y <= year + 1; y++) { %>
                  <option value="<%= y %>" <%= y === year ? 'selected' : '' %>><%= y %></option>
                <% } %>
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Month</label>
              <select id="expMonth" class="form-select">
                <option value="">All</option>
                <option value="1">Jan</option>
                <option value="2">Feb</option>
                <option value="3">Mar</option>
                <option value="4">Apr</option>
                <option value="5">May</option>
                <option value="6">Jun</option>
                <option value="7">Jul</option>
                <option value="8">Aug</option>
                <option value="9">Sep</option>
                <option value="10">Oct</option>
                <option value="11">Nov</option>
                <option value="12">Dec</option>
              </select>
            </div>
          </div>

          <!-- Add Expense heading -->
          <h6 class="mb-2">Add Expense</h6>
          <div class="card shadow-sm mb-4">
            <div class="card-body">
              <form id="expForm" class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Title</label>
                  <input type="text" name="title" class="form-control" required />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Amount</label>
                  <input type="number" name="amount" min="0" step="1" class="form-control" required />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Date</label>
                  <input type="date" name="date" class="form-control" />
                </div>
                <div class="col-md-2 d-flex align-items-end">
                  <button type="submit" class="btn btn-primary w-100">Save</button>
                </div>
              </form>
              <small id="expMsg" class="text-muted"></small>
            </div>
          </div>

          <!-- Expenses table heading -->
          <h6 class="mb-2">Expenses List</h6>
          <div class="card shadow-sm">
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0">
                <thead>
                  <tr>
                    <th>#</th>
                    <th>Title</th>
                    <th>Amount</th>
                    <th>Date</th>
                  </tr>
                </thead>
                <tbody id="expTableBody"></tbody>
              </table>
            </div>
          </div>

        </main>

      </div>

  </div>

  <script>
    const expYear = document.getElementById("expYear");
    const expMonth = document.getElementById("expMonth");
    const expForm = document.getElementById("expForm");
    const expMsg = document.getElementById("expMsg");
    const expTableBody = document.getElementById("expTableBody");

    async function loadExpenses() {
      const year = expYear.value;
      const month = expMonth.value;

      const params = new URLSearchParams();
      if (year) params.append("year", year);
      if (month) params.append("month", month);

      const res = await fetch(`/admin/expenses?${params.toString()}`);
      const json = await res.json();
      if (!json.success) return;

      const expenses = json.expenses || [];
      expTableBody.innerHTML = "";

      expenses.forEach((e, index) => {
        const tr = document.createElement("tr");
        const d = e.date ? new Date(e.date) : null;
        const dateText = d ? d.toLocaleDateString() : "-";

        tr.innerHTML = `
          <td>${index + 1}</td>
          <td>${e.title}</td>
          <td>${e.amount}</td>
          <td>${dateText}</td>
        `;
        expTableBody.appendChild(tr);
      });
    }

    expYear.addEventListener("change", loadExpenses);
    expMonth.addEventListener("change", loadExpenses);

    if (expForm) {
      expForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        expMsg.textContent = "";

        const formData = new FormData(expForm);
        const payload = {
          title: formData.get("title"),
          amount: formData.get("amount"),
          date: formData.get("date") || undefined,
        };

        try {
          const res = await fetch("/admin/expenses", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const json = await res.json();
          if (!json.success) {
            expMsg.textContent = json.message || "Failed to add expense";
            expMsg.classList.remove("text-success");
            expMsg.classList.add("text-danger");
            return;
          }

          expMsg.textContent = "Expense added";
          expMsg.classList.remove("text-danger");
          expMsg.classList.add("text-success");
          expForm.reset();

          loadExpenses();
        } catch (err) {
          console.error(err);
          expMsg.textContent = "Error adding expense";
          expMsg.classList.remove("text-success");
          expMsg.classList.add("text-danger");
        }
      });
    }

    // Initial load
    loadExpenses();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
