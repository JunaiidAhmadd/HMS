<%- include("partials/user_header", { pageTitle: "My Dashboard" }) %>

  <body class="bg-light">

    <!-- NAVBAR -->
    <%- include("partials/user_navbar") %>

      <div class="container py-4">

        <!-- ===================== PROFILE ===================== -->
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <h4 class="fw-bold mb-3">üë§ My Profile</h4>

            <div class="row small">
              <div class="col-12 col-md-4 mb-2"><strong>Name:</strong>
                <%= user.fullName %>
              </div>
              <div class="col-12 col-md-4 mb-2"><strong>Email:</strong>
                <%= user.email %>
              </div>
              <div class="col-12 col-md-4 mb-2"><strong>Phone:</strong>
                <%= user.phone || "-" %>
              </div>
            </div>
          </div>
        </div>

        <!-- ===================== RENT SUMMARY ===================== -->
        <div class="card shadow-sm border-0 mb-4">
          <div class="card-body">
            <h4 class="fw-bold mb-3">üìä Rent Summary</h4>

            <div class="row text-center small">
              <div class="col-4 mb-3">
                <div class="p-2 bg-light rounded shadow-sm">
                  <strong>Total Paid</strong>
                  <div class="fw-bold text-success">PKR <%= stats.totalPaid %>
                  </div>
                </div>
              </div>

              <div class="col-4 mb-3">
                <div class="p-2 bg-light rounded shadow-sm">
                  <strong>Pending</strong>
                  <div class="fw-bold text-danger">
                    <%= stats.pendingMonths %>
                  </div>
                </div>
              </div>

              <div class="col-4 mb-3">
                <div class="p-2 bg-light rounded shadow-sm">
                  <strong>Next Due</strong>
                  <div class="fw-bold text-primary">
                    <%= stats.nextDueDate %>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ===================== RESERVATIONS ===================== -->
        <h5 class="fw-bold mb-3">üè† My Reservations</h5>

        <% if (!reservations || reservations.length===0) { %>

          <div class="alert alert-info small">
            You have no reservations yet.
            <a href="/user/reservation">Reserve a room</a>
          </div>

          <% } else { %>

            <!-- MOBILE LIST -->
            <div class="d-md-none">

              <% reservations.forEach(r=> { %>
                <div class="card shadow-sm p-3 border-0 mb-3 small">

                  <div>
                    <div><strong>Booking ID:</strong>
                      <%= r._id.toString().slice(-6).toUpperCase() %>
                    </div>
                    <div><strong>Branch:</strong>
                      <%= r.branchId?.name %>
                    </div>
                    <div><strong>Room:</strong>
                      <%= r.roomType %>
                    </div>
                    <div><strong>Occupants:</strong>
                      <%= r.occupants %>
                    </div>
                    <div><strong>Start:</strong>
                      <%= new Date(r.startDate).toLocaleDateString() %>
                    </div>
                    <div><strong>Months:</strong>
                      <%= r.durationMonths %>
                    </div>
                    <div><strong>Price:</strong> PKR <%= r.price %>
                    </div>

                    <div class="mt-2">
                      <strong>Status:</strong>
                      <% if (r.status==="Approved" ) { %>
                        <span class="badge bg-success">Approved</span>
                        <% } else if (r.status==="Pending" ) { %>
                          <span class="badge bg-warning text-dark">Pending</span>
                          <% } else { %>
                            <span class="badge bg-danger">Rejected</span>
                            <% } %>
                    </div>
                  </div>

                  <% if (r.status==="Approved" ) { %>
                    <button class="btn btn-primary btn-sm mt-2 open-rent-modal" data-id="<%= r._id %>"
                      data-price="<%= r.price %>">
                      Pay Rent
                    </button>
                    <% } %>

                </div>
                <% }) %>

            </div>

            <!-- DESKTOP TABLE -->
            <div class="card shadow-sm border-0 mb-4 d-none d-md-block">
              <div class="card-body">
                <table class="table table-striped table-sm align-middle">

                  <thead class="small">
                    <tr>
                      <th>Booking ID</th>
                      <th>Branch</th>
                      <th>Room</th>
                      <th>Occupants</th>
                      <th>Start</th>
                      <th>Months</th>
                      <th>Price</th>
                      <th>Status</th>
                      <th>Pay</th>
                      <th>Delete</th>
                    </tr>
                  </thead>

                  <tbody class="small">
                    <% reservations.forEach(r=> { %>
                      <tr>
                        <td>
                          <%= r._id.toString().slice(-6).toUpperCase() %>
                        </td>
                        <td>
                          <%= r.branchId?.name %>
                        </td>
                        <td>
                          <%= r.roomType %>
                        </td>
                        <td>
                          <%= r.occupants %>
                        </td>
                        <td>
                          <%= new Date(r.startDate).toLocaleDateString() %>
                        </td>
                        <td>
                          <%= r.durationMonths %>
                        </td>
                        <td>PKR <%= r.price %>
                        </td>

                        <td>
                          <% if (r.status==="Approved" ) { %>
                            <span class="badge bg-success">Approved</span>
                            <% } else if (r.status==="Pending" ) { %>
                              <span class="badge bg-warning text-dark">Pending</span>
                              <% } else { %>
                                <span class="badge bg-danger">Rejected</span>
                                <% } %>
                        </td>

                        <td>
                          <% if (r.status==="Approved" ) { %>
                            <button class="btn btn-primary btn-sm open-rent-modal" data-id="<%= r._id %>"
                              data-price="<%= r.price %>">
                              Pay
                            </button>
                            <% } else { %> - <% } %>
                        </td>
                        <td>
                          <% if (r.status !=="Approved" ) { %>
                            <form action="/user/reservations/<%= r._id %>/delete" method="POST" style="display: inline;"
                              onsubmit="return confirm('Are you sure you want to delete this reservation?');">
                              <button type="submit" class="btn btn-danger btn-sm">
                                <i class="bi bi-trash"></i>
                              </button>
                            </form>
                            <% } else { %>
                              <span class="text-muted">-</span>
                              <% } %>
                        </td>
                      </tr>
                      <% }) %>
                  </tbody>

                </table>
              </div>
            </div>

            <% } %>

              <!-- ===================== PAYMENT HISTORY ===================== -->
              <h5 class="fw-bold mb-3">üí≥ Payment History</h5>

              <div class="card shadow-sm border-0 mb-5">
                <div class="card-body small">

                  <% if (!payments || payments.length===0) { %>

                    <p class="text-muted">No payments submitted yet.</p>

                    <% } else { %>

                      <!-- MOBILE PAYMENTS -->
                      <div class="d-md-none">
                        <% payments.forEach(p=> { %>
                          <div class="p-2 mb-2 bg-white border rounded shadow-sm">

                            <div><strong>Month:</strong>
                              <%= p.monthName || p.month %>
                            </div>
                            <div><strong>Year:</strong>
                              <%= p.year %>
                            </div>
                            <div><strong>Amount:</strong> PKR <%= p.amount %>
                            </div>
                            <div><strong>Method:</strong>
                              <%= p.method %>
                            </div>

                            <div class="mt-1">
                              <strong>Status:</strong>
                              <% if (p.status==="Confirmed" ) { %>
                                <span class="badge bg-success">Confirmed</span>
                                <% } else if (p.status==="Rejected" ) { %>
                                  <span class="badge bg-danger">Rejected</span>
                                  <% } else { %>
                                    <span class="badge bg-warning text-dark">Pending</span>
                                    <% } %>
                            </div>

                            <% if (p.screenshot) { %>
                              <a class="btn btn-primary btn-sm w-100 mt-2" href="<%= p.screenshot %>" target="_blank">
                                View Receipt
                              </a>
                              <% } else { %>
                                <button class="btn btn-secondary btn-sm w-100 mt-2" disabled>No Receipt</button>
                                <% } %>

                          </div>
                          <% }) %>
                      </div>

                      <!-- DESKTOP TABLE -->
                      <div class="table-responsive d-none d-md-block">
                        <table class="table table-striped table-sm align-middle">

                          <thead>
                            <tr>
                              <th>Month</th>
                              <th>Year</th>
                              <th>Amount</th>
                              <th>Method</th>
                              <th>Status</th>
                              <th>Receipt</th>
                            </tr>
                          </thead>

                          <tbody>
                            <% payments.forEach(p=> { %>
                              <tr>
                                <td>
                                  <%= p.monthName || p.month %>
                                </td>
                                <td>
                                  <%= p.year %>
                                </td>
                                <td>PKR <%= p.amount %>
                                </td>
                                <td>
                                  <%= p.method %>
                                </td>

                                <td>
                                  <% if (p.status==="Confirmed" ) { %>
                                    <span class="badge bg-success">Confirmed</span>
                                    <% } else if (p.status==="Rejected" ) { %>
                                      <span class="badge bg-danger">Rejected</span>
                                      <% } else { %>
                                        <span class="badge bg-warning text-dark">
                                          Pending
                                        </span>
                                        <% } %>
                                </td>

                                <td>
                                  <% if (p.screenshot) { %>
                                    <a class="btn btn-sm btn-outline-primary" href="<%= p.screenshot %>"
                                      target="_blank">View</a>
                                    <% } else { %>
                                      -
                                      <% } %>
                                </td>

                              </tr>
                              <% }) %>
                          </tbody>

                        </table>
                      </div>

                      <% } %>

                </div>
              </div>

      </div>

      <!-- ===================== RENT MODAL ===================== -->
      <div class="modal fade" id="rentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">

          <form class="modal-content" action="/user/rent/upload" method="POST" enctype="multipart/form-data">

            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title">Pay Monthly Rent</h5>
              <button type="button" class="btn-close bg-light" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body small">
              <input type="hidden" name="reservationId" id="modal_reservation_id">

              <div class="mb-2">
                <label class="form-label">Select Month</label>
                <input type="month" name="monthYear" required class="form-control">
              </div>

              <div class="mb-2">
                <label class="form-label">Amount (PKR)</label>
                <input type="number" id="modal_amount" name="amount" required min="1" class="form-control">
              </div>

              <div class="mb-2">
                <label class="form-label">Payment Method</label>
                <select name="method" id="paymentMethod" class="form-select" required>
                  <option value="cash">Cash</option>
                  <option value="online">Online Transfer</option>
                </select>
              </div>

              <div class="mb-2 d-none" id="screenshotField">
                <label class="form-label">Upload Screenshot (Required for Online)</label>
                <input type="file" name="screenshot" id="screenshotInput" class="form-control">
              </div>
            </div>

            <div class="modal-footer">
              <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
              <button type="submit" class="btn btn-primary btn-sm">Submit Payment</button>
            </div>

          </form>
        </div>
      </div>

      <!-- ===================== SCRIPTS ===================== -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

      <script>
        document.querySelectorAll(".open-rent-modal").forEach(btn => {
          btn.addEventListener("click", () => {
            document.getElementById("modal_reservation_id").value = btn.dataset.id;
            document.getElementById("modal_amount").value = btn.dataset.price;
            new bootstrap.Modal(document.getElementById("rentModal")).show();
          });
        });

        // Toggle Screenshot Field
        const methodSelect = document.getElementById("paymentMethod");
        const screenshotField = document.getElementById("screenshotField");
        const screenshotInput = document.getElementById("screenshotInput");

        methodSelect.addEventListener("change", function () {
          if (this.value === "online") {
            screenshotField.classList.remove("d-none");
            screenshotInput.setAttribute("required", "required");
          } else {
            screenshotField.classList.add("d-none");
            screenshotInput.removeAttribute("required");
            screenshotInput.value = ""; // Clear file
          }
        });
      </script>

  </body>

  </html>